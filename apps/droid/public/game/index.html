<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spark Catcher - The IDEA</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; touch-action: none; }
        #ui { position: absolute; top: 20px; width: 100%; text-align: center; color: #fff; pointer-events: none; z-index: 10; }
        #score { font-size: 40px; font-weight: bold; text-shadow: 0 0 10px #facc15; }
        #energy-bar { width: 200px; height: 10px; background: #333; margin: 10px auto; border-radius: 5px; overflow: hidden; }
        #energy-fill { width: 100%; height: 100%; background: #facc15; transition: width 0.2s; }
        #game-over { display: none; position: absolute; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 20; }
        button { background: #facc15; border: none; padding: 15px 30px; font-size: 20px; font-weight: bold; border-radius: 30px; cursor: pointer; color: #000; }
    </style>
</head>
<body>
    <div id="ui">
        <div id="score">0</div>
        <div id="energy-bar"><div id="energy-fill"></div></div>
    </div>
    
    <div id="game-over">
        <h1>LIGHTS OUT</h1>
        <p>Score: <span id="final-score">0</span></p>
        <button onclick="startGame()">REIGNITE âš¡</button>
    </div>

    <canvas id="game"></canvas>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        let canvasWidth, canvasHeight;

        // Game State
        let running = false;
        let score = 0;
        let energy = 100;
        let playerX = 0;
        
        let items = []; // Falling objects
        const particles = [];

        function resize() {
            canvasWidth = canvas.width = window.innerWidth;
            canvasHeight = canvas.height = window.innerHeight;
            playerX = canvasWidth / 2;
        }
        window.addEventListener('resize', resize);
        resize();

        // Input
        document.addEventListener('touchmove', e => {
            if (e.touches && e.touches.length > 0) {
                playerX = e.touches[0].clientX;
            }
        }, { passive: false });
        document.addEventListener('mousemove', e => {
            playerX = e.clientX;
        });

        class Item {
            constructor() {
                this.x = Math.random() * canvasWidth;
                this.y = -50;
                this.type = Math.random() > 0.8 ? 'bug' : 'bulb';
                this.speed = 3 + Math.random() * 5;
                this.size = 20;
            }
            update() {
                this.y += this.speed;
            }
            draw() {
                ctx.font = "30px Arial";
                ctx.textAlign = "center";
                ctx.fillText(this.type === 'bulb' ? 'ðŸ’¡' : 'ðŸ‘¾', this.x, this.y);
            }
        }

        function startGame() {
            document.getElementById('game-over').style.display = 'none';
            score = 0;
            energy = 100;
            items = [];
            running = true;
            loop();
        }

        function loop() {
            if (!running) return;

            // Clear & Background
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, w, h);

            // Player (The Filament)
            ctx.strokeStyle = '#facc15';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(playerX, h - 20);
            ctx.lineTo(playerX, h); // Anchor
            ctx.stroke();
            
            // Player Glow
            ctx.shadowBlur = 20;
            ctx.shadowColor = '#facc15';
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(playerX, canvasHeight - 30, 10, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;

            // Spawner
            if (Math.random() < 0.05) items.push(new Item());

            // Logic
            for (let i = items.length - 1; i >= 0; i--) {
                const item = items[i];
                item.update();
                item.draw();

                // Collision
                const dist = Math.hypot(item.x - playerX, item.y - (h - 30));
                if (dist < 40) {
                    if (item.type === 'bulb') {
                        score += 10;
                        energy = Math.min(100, energy + 10);
                        // Trigger Haptic
                        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback && typeof window.Telegram.WebApp.HapticFeedback.impactOccurred === 'function') {
                            window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
                        }
                    } else {
                        energy -= 30;
                        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback && typeof window.Telegram.WebApp.HapticFeedback.notificationOccurred === 'function') {
                            window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                        }
                    }
                    items.splice(i, 1);
                } else if (item.y > h) {
                    items.splice(i, 1);
                    if (item.type === 'bulb') energy -= 5; // Missed opportunity
                }
            }

            // UI Update
            document.getElementById('score').innerText = score;
            document.getElementById('energy-fill').style.width = energy + '%';
            document.getElementById('energy-fill').style.backgroundColor = energy < 30 ? '#ef4444' : '#facc15';

            if (energy <= 0) {
                running = false;
                document.getElementById('game-over').style.display = 'flex';
                document.getElementById('final-score').innerText = score;
            }

            requestAnimationFrame(loop);
        }

        // Auto Start
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        }
        startGame();

    </script>
</body>
</html>
