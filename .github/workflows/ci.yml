name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    types: [opened, synchronize]

jobs:
  build:
    name: Build and Test
    timeout-minutes: 15
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ vars.TURBO_TEAM }}
      # Dummy values to bypass validation in CI
      SKIP_ENV_VALIDATION: "true"
      # Web
      NEXT_PUBLIC_SUPABASE_URL: "https://dummy-project.supabase.co"
      NEXT_PUBLIC_SUPABASE_ANON_KEY: "dummy-anon-key"
      NEXT_PUBLIC_SITE_URL: "http://localhost:3000"
      WAYL_SECRET_KEY: "dummy-wayl-key"
      WAYL_WEBHOOK_SECRET: "dummy-webhook-secret"
      ZAIN_SECRET_KEY: "dummy-zain-key"
      SUPABASE_SERVICE_ROLE_KEY: "dummy-service-role-key"
      # Admin
      RESEND_API_KEY: "re_123456789"
      # Droid
      TELEGRAM_BOT_TOKEN: "123456789:DUMMY_TELEGRAM_BOT_TOKEN_FOR_CI_TESTING"
      GEMINI_API_KEY: "dummy-gemini-key"
      UPSTASH_REDIS_REST_URL: "https://dummy-redis.upstash.io"
      UPSTASH_REDIS_REST_TOKEN: "dummy-redis-token"
      WEB_APP_URL: "http://localhost:3000"

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: pnpm/action-setup@v3
        with:
          version: 10.27.0

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 24.12.0
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --config.engine-strict=false

      - name: Build
        run: pnpm build

      - name: Lint
        run: pnpm check

      - name: Test
        run: pnpm test

  gitleaks:
    name: Gitleaks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        continue-on-error: true
